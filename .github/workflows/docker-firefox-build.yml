# ============================================================================
# GitHub Actions Workflow: æ‰‹åŠ¨æ„å»º Firefox Docker é•œåƒ
# ============================================================================
#
# è¿™ä¸ª workflow çš„ä½œç”¨ï¼š
#   - æ„å»ºæ”¯æŒå¤šå¹³å°ï¼ˆamd64 + arm64ï¼‰çš„ Firefox Docker é•œåƒ
#   - å¯ä»¥æ‰‹åŠ¨è§¦å‘ï¼ˆç‚¹å‡»æŒ‰é’®è¿è¡Œï¼‰
#   - å¯é€‰æ‹©æ˜¯å¦æ¨é€åˆ° GitHub Container Registry (ghcr.io)
#
# ä»€ä¹ˆæ˜¯ workflowï¼Ÿ
#   - GitHub Actions çš„è‡ªåŠ¨åŒ–è„šæœ¬
#   - ç”±å¤šä¸ª jobsï¼ˆä»»åŠ¡ï¼‰ç»„æˆ
#   - æ¯ä¸ª job åŒ…å«å¤šä¸ª stepsï¼ˆæ­¥éª¤ï¼‰
# ============================================================================

# workflow çš„åç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨ GitHub Actions é¡µé¢
name: Firefox Image Build

# ============================================================================
# on: è§¦å‘æ¡ä»¶ - ä»€ä¹ˆæ—¶å€™è¿è¡Œè¿™ä¸ª workflow
# ============================================================================
on:
  # workflow_dispatch: å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ Actions é¡µé¢ä¼šå‡ºç° "Run workflow" æŒ‰é’®ï¼‰
  workflow_dispatch:
    # inputs: è¿è¡Œæ—¶å¯ä»¥å¡«å†™çš„å‚æ•°ï¼ˆä¼šåœ¨ç‚¹å‡» "Run workflow" æ—¶å¼¹å‡ºï¼‰
    inputs:
      push_to_registry:
        # å‚æ•°çš„è¯´æ˜æ–‡å­—
        description: 'æ˜¯å¦æ¨é€åˆ° ghcr.io (è‡ªåŠ¨ä½¿ç”¨ GITHUB_TOKENï¼Œæ— éœ€é…ç½®)'
        required: false    # æ˜¯å¦å¿…å¡«
        default: 'true'    # é»˜è®¤å€¼
        type: choice       # ç±»å‹ï¼šé€‰æ‹©æ¡†
        options:
          - 'true'         # é€‰é¡¹1ï¼šæ¨é€
          - 'false'        # é€‰é¡¹2ï¼šä¸æ¨é€

# ============================================================================
# jobs: å®šä¹‰è¦æ‰§è¡Œçš„ä»»åŠ¡
# ============================================================================
jobs:
  # job IDï¼ˆå¯ä»¥è‡ªå®šä¹‰åç§°ï¼‰
  build-firefox:
    # runs-on: æŒ‡å®šè¿è¡Œç¯å¢ƒï¼ˆGitHub æä¾›çš„è™šæ‹Ÿæœºï¼‰
    # ubuntu-latest = æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu Linux
    runs-on: ubuntu-latest

    # ========================================================================
    # steps: è¿™ä¸ª job åŒ…å«çš„å…·ä½“æ­¥éª¤ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰
    # ========================================================================
    steps:
      # ----------------------------------------------------------------------
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ----------------------------------------------------------------------
      # name: æ­¥éª¤çš„åç§°ï¼ˆæ˜¾ç¤ºåœ¨æ—¥å¿—ä¸­ï¼‰
      - name: Checkout code
        # uses: ä½¿ç”¨ç°æˆçš„ actionï¼ˆåˆ«äººå†™å¥½çš„æ¨¡å—ï¼‰
        # actions/checkout@v3 = GitHub å®˜æ–¹æä¾›çš„æ£€å‡ºä»£ç å·¥å…·
        uses: actions/checkout@v3
        # ä½œç”¨ï¼šæŠŠä½ çš„ä»“åº“ä»£ç ä¸‹è½½åˆ°è™šæ‹Ÿæœºä¸­

      # ----------------------------------------------------------------------
      # æ­¥éª¤ 2: è®¾ç½® QEMUï¼ˆç”¨äºè·¨å¹³å°æ„å»ºï¼‰
      # ----------------------------------------------------------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        # QEMU æ˜¯ä»€ä¹ˆï¼Ÿ
        #   - ä¸€ä¸ªæ¨¡æ‹Ÿå™¨ï¼Œå¯ä»¥åœ¨ x86 æœºå™¨ä¸Šæ„å»º ARM é•œåƒ
        #   - è®© GitHub çš„ x86 æœåŠ¡å™¨å¯ä»¥æ„å»º arm64 é•œåƒ

      # ----------------------------------------------------------------------
      # æ­¥éª¤ 3: è®¾ç½® Docker Buildxï¼ˆDocker çš„é«˜çº§æ„å»ºå·¥å…·ï¼‰
      # ----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        # Docker Buildx æ˜¯ä»€ä¹ˆï¼Ÿ
        #   - Docker çš„æ‰©å±•æ„å»ºå·¥å…·
        #   - æ”¯æŒå¤šå¹³å°æ„å»ºï¼ˆåŒæ—¶æ„å»º amd64 å’Œ arm64ï¼‰
        #   - æ”¯æŒæ„å»ºç¼“å­˜ï¼ˆåŠ é€Ÿåç»­æ„å»ºï¼‰

      # ----------------------------------------------------------------------
      # æ­¥éª¤ 4: ç™»å½•åˆ° GitHub Container Registry
      # ----------------------------------------------------------------------
      # if: æ¡ä»¶åˆ¤æ–­ - åªæœ‰å½“ç”¨æˆ·é€‰æ‹©æ¨é€æ—¶æ‰æ‰§è¡Œè¿™æ­¥
      - name: Log in to GitHub Container Registry
        if: ${{ github.event.inputs.push_to_registry == 'true' }}
        uses: docker/login-action@v2
        # with: ä¼ é€’å‚æ•°ç»™è¿™ä¸ª action
        with:
          registry: ghcr.io                        # è¦ç™»å½•çš„ä»“åº“åœ°å€
          username: ${{ github.actor }}            # ä½ çš„ GitHub ç”¨æˆ·åï¼ˆè‡ªåŠ¨è·å–ï¼‰
          password: ${{ secrets.GITHUB_TOKEN }}    # GitHub è‡ªåŠ¨æä¾›çš„ tokenï¼ˆæ— éœ€é…ç½®ï¼‰
        # ä½œç”¨ï¼šç™»å½•åˆ° ghcr.ioï¼Œè¿™æ ·æ‰èƒ½æ¨é€é•œåƒ

      # ----------------------------------------------------------------------
      # æ­¥éª¤ 5: æ„å»º base é•œåƒï¼ˆåŸºç¡€é•œåƒï¼‰
      # ----------------------------------------------------------------------
      - name: Build base image
        uses: docker/build-push-action@v5
        # with: é…ç½®æ„å»ºå‚æ•°
        with:
          context: .                                  # æ„å»ºä¸Šä¸‹æ–‡ï¼ˆå½“å‰ç›®å½•ï¼‰
          file: ./docker/base/Dockerfile              # Dockerfile è·¯å¾„
          tags: ghcr.io/browserless/base:latest       # é•œåƒæ ‡ç­¾
          # platforms: æŒ‡å®šè¦æ„å»ºçš„å¹³å°ï¼ˆå¤šå¹³å°æ„å»ºï¼‰
          # è¿™ä¼šåŒæ—¶æ„å»ºä¸¤ä¸ªç‰ˆæœ¬ï¼š
          #   - linux/amd64: é€‚ç”¨äº Intel/AMD å¤„ç†å™¨ï¼ˆx86_64ï¼‰
          #   - linux/arm64: é€‚ç”¨äº ARM å¤„ç†å™¨ï¼ˆå¦‚ Apple Silicon, AWS Gravitonï¼‰
          platforms: |
            linux/amd64
            linux/arm64
          push: false                                 # ä¸æ¨é€ base é•œåƒï¼ˆä»…ç”¨äºåç»­æ„å»ºï¼‰
          # cache-from: ä» GitHub Actions ç¼“å­˜è¯»å–ï¼ˆåŠ é€Ÿæ„å»ºï¼‰
          cache-from: type=gha
          # cache-to: å°†æ„å»ºç¼“å­˜ä¿å­˜åˆ° GitHub Actionsï¼ˆmode=max ä¿å­˜æ‰€æœ‰å±‚ï¼‰
          cache-to: type=gha,mode=max

      # ----------------------------------------------------------------------
      # æ­¥éª¤ 6: æ„å»º Firefox é•œåƒ
      # ----------------------------------------------------------------------
      - name: Build Firefox image
        uses: docker/build-push-action@v5
        # with: é…ç½® Firefox é•œåƒçš„æ„å»ºå‚æ•°
        with:
          context: .                                  # æ„å»ºä¸Šä¸‹æ–‡
          file: ./docker/firefox/Dockerfile           # ä½¿ç”¨åŸå§‹é¡¹ç›®çš„ Firefox Dockerfile
          # build-args: ä¼ é€’ç»™ Dockerfile çš„æ„å»ºå‚æ•°
          build-args: |
            VERSION=latest
          # tags: ç»™é•œåƒæ‰“æ ‡ç­¾ï¼ˆå¯ä»¥æœ‰å¤šä¸ªï¼‰
          # ${{ github.repository_owner }} = ä½ çš„ GitHub ç”¨æˆ·å
          # ${{ github.sha }} = å½“å‰ commit çš„ SHA å€¼
          tags: |
            ghcr.io/${{ github.repository_owner }}/browserless-firefox:latest
            ghcr.io/${{ github.repository_owner }}/browserless-firefox:${{ github.sha }}
          # platforms: å¤šå¹³å°æ„å»º
          # Docker ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª manifestï¼ŒåŒ…å«ä¸¤ä¸ªå¹³å°çš„é•œåƒ
          # ç”¨æˆ·æ‹‰å–æ—¶ä¼šè‡ªåŠ¨é€‰æ‹©åŒ¹é…çš„å¹³å°
          platforms: |
            linux/amd64
            linux/arm64
          # push: æ˜¯å¦æ¨é€åˆ° ghcr.ioï¼ˆå–å†³äºç”¨æˆ·çš„é€‰æ‹©ï¼‰
          push: ${{ github.event.inputs.push_to_registry == 'true' }}
          # ä½¿ç”¨ GitHub Actions ç¼“å­˜åŠ é€Ÿæ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ----------------------------------------------------------------------
      # æ­¥éª¤ 7: æ˜¾ç¤ºæ„å»ºæ‘˜è¦
      # ----------------------------------------------------------------------
      - name: Build summary
        # run: ç›´æ¥è¿è¡Œ shell å‘½ä»¤ï¼ˆä¸ä½¿ç”¨ actionï¼‰
        # | è¡¨ç¤ºå¤šè¡Œå­—ç¬¦ä¸²ï¼ˆYAML è¯­æ³•ï¼‰
        run: |
          echo "âœ… Firefox å¤šå¹³å°é•œåƒæ„å»ºå®Œæˆï¼"
          echo ""
          echo "ğŸ—ï¸  æ”¯æŒçš„å¹³å°ï¼š"
          echo "  - linux/amd64 (x86_64)"
          echo "  - linux/arm64 (aarch64)"
          echo ""
          # if åˆ¤æ–­ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†æ¨é€
          if [ "${{ github.event.inputs.push_to_registry }}" == "true" ]; then
            echo "ğŸ“¦ é•œåƒå·²æ¨é€åˆ°: ghcr.io/${{ github.repository_owner }}/browserless-firefox:latest"
            echo ""
            echo "æ‹‰å–å‘½ä»¤ï¼ˆä¼šè‡ªåŠ¨é€‰æ‹©åŒ¹é…çš„å¹³å°ï¼‰:"
            echo "  docker pull ghcr.io/${{ github.repository_owner }}/browserless-firefox:latest"
            echo ""
            echo "è¿è¡Œå‘½ä»¤:"
            echo "  docker run -d -p 3000:3000 -e TOKEN=your-token ghcr.io/${{ github.repository_owner }}/browserless-firefox:latest"
          else
            echo "âš ï¸  é•œåƒæœªæ¨é€åˆ°ä»“åº“ï¼ˆåœ¨æœ¬æ¬¡è¿è¡Œä¸­é€‰æ‹©äº† 'false'ï¼‰"
            echo ""
            echo "å¦‚éœ€æ¨é€ï¼Œè¯·é‡æ–°è¿è¡Œ workflow å¹¶é€‰æ‹© 'true'"
          fi
